# 시나리오 확률 개선방안

**분석일**: 2025-12-15
**분석 대상**: kr_stock_grade 테이블 전체 데이터
**분석 도구**: analyze_scenario_calibration.py

---

## 1. 현황 분석 요약

### 1.1 전체 예측 오차 현황

| 구분 | 평균 예측값 | 실제 발생률 | 오차 | 문제점 |
|------|------------|------------|------|--------|
| Bullish | 27.4% | 19.4% | +8.0%p | 과대예측 |
| Sideways | 39.3% | 57.7% | -18.4%p | 과소예측 |
| Bearish | 33.2% | 22.9% | +10.3%p | 과대예측 |

**핵심 발견**: 현재 Calibration 로직이 **Bullish와 Bearish를 과대예측**하고, **Sideways를 과소예측**함.

### 1.2 Theme별 Calibration 오차

| Theme | 샘플수 | Bullish 오차 | Bearish 오차 | 총 오차 | 심각도 |
|-------|--------|-------------|-------------|---------|--------|
| Finance | 8,663 | +11.4%p | +14.4%p | 51.6%p | 매우 심각 |
| Consumer_Goods | 13,437 | +11.9%p | +12.8%p | 49.3%p | 매우 심각 |
| Others | 7,982 | +14.7%p | +9.1%p | 47.6%p | 매우 심각 |
| Traditional_Manufacturing | 11,543 | +13.2%p | +10.1%p | 46.5%p | 심각 |
| IT_Software | 6,040 | +8.6%p | +13.7%p | 44.6%p | 심각 |
| Energy | 1,734 | +6.1%p | +14.7%p | 41.4%p | 심각 |
| Telecom_Media | 5,768 | +11.5%p | +8.8%p | 40.6%p | 심각 |
| Materials_Chemical | 8,655 | +9.8%p | +10.5%p | 40.5%p | 심각 |
| Pharma_CDMO | 5,612 | +8.6%p | +9.8%p | 36.7%p | 보통 |
| Healthcare_Device | 3,402 | +10.4%p | +5.0%p | 30.7%p | 보통 |
| Electronics | 7,496 | +8.1%p | +7.0%p | 30.1%p | 보통 |
| Battery | 2,024 | +0.9%p | +13.2%p | 28.0%p | 보통 |
| Advanced_Manufacturing | 5,452 | +2.3%p | +11.8%p | 28.0%p | 보통 |
| **Semiconductor** | 4,985 | **-8.2%p** | +11.1%p | 22.2%p | 양호 |
| Bio_DrugRD | 2,659 | +2.4%p | +8.5%p | 21.8%p | 양호 |
| AI_BigData | 1,266 | +6.8%p | **-8.4%p** | 16.8%p | 양호 |
| Shipbuilding | 542 | +1.5%p | +6.2%p | 15.4%p | 양호 |

**주요 발견**:
- **Semiconductor**: 유일하게 Bullish를 **과소예측** (예측 40.8% vs 실제 49.0%)
- **AI_BigData**: 유일하게 Bearish를 **과소예측** (예측 35.6% vs 실제 44.0%)
- **Finance, Consumer_Goods**: Bearish 과대예측이 가장 심각

### 1.3 삼성전자 패턴 오류 사례

**오류 정의**: Backtest Bearish < 15%인데 최종 Bearish > 30%인 케이스

| 통계 | 값 |
|------|-----|
| 총 오류 사례 | **500건** |
| 가장 심한 Bearish 부풀림 | +47.0%p |
| 주요 발생 Theme | Consumer_Goods, Telecom_Media |

**대표 오류 사례**:

| 종목 | Theme | Backtest Bearish | 최종 Bearish | 부풀림 |
|------|-------|------------------|-------------|--------|
| 하이브 | Telecom_Media | 0.0% | 47% | +47.0%p |
| 알비더블유 | Telecom_Media | 0.0% | 47% | +47.0%p |
| 크라운제과 | Consumer_Goods | 0.0% | 45% | +45.0%p |
| KT&G | Consumer_Goods | 0.0% | 44% | +44.0%p |
| 삼성전자 | Electronics | 6.7% | 36% | +29.3%p |

### 1.4 Sample Count별 예측 정확도

| Sample 범위 | 샘플수 | Bullish 오차 | Bearish 오차 | 총 오차 |
|-------------|--------|-------------|-------------|---------|
| 0-19 | 7,649 | 15.1%p | 16.1%p | **62.3%p** |
| 20-49 | 6,757 | 8.4%p | 10.2%p | 37.0%p |
| 50-99 | 8,338 | 9.0%p | 11.4%p | 40.8%p |
| 100-199 | 11,369 | 7.8%p | 11.5%p | 38.6%p |
| 200+ | 36,516 | 8.0%p | 10.3%p | **36.7%p** |

**발견**: Sample Count가 낮을수록 오차가 큼 (0-19: 62.3%p vs 200+: 36.7%p)

---

## 2. 핵심 문제점

### 2.1 현재 Calibration 승수의 문제

현재 `kr_probability_calibrator.py`의 CALIBRATION_MAP:

```python
# 현재 설정 (문제 있음)
CALIBRATION_MAP = {
    'bullish': {
        (0, 20): 1.55,   # 낮은 예측 -> 1.55배 증가
        (20, 40): 1.32,
        (40, 60): 1.28,
        (60, 80): 1.23,
        (80, 100): 1.15
    },
    'bearish': {
        (0, 20): 3.01,   # 낮은 예측 -> 3.01배 증가 (문제!)
        (20, 40): 1.48,
        (40, 60): 1.39,
        (60, 80): 1.26,
        (80, 100): 1.20
    }
}
```

**문제점**:
1. **Bearish (0-20%) 구간의 3.01배 승수가 과도함**
   - 삼성전자: Backtest 6.7% -> 3.01배 -> 20.2% -> 정규화 후 36%
   - 실제로는 Bearish 비율이 낮은 종목을 오히려 높게 예측

2. **Theme 특성을 무시한 일괄 적용**
   - Semiconductor: 실제 Bearish 18.9%인데 예측 30.0%
   - Finance: 실제 Bearish 11.9%인데 예측 26.3%

3. **Sideways 확률이 잔차로 계산됨**
   - Bullish + Bearish가 과대예측되면 Sideways가 자동으로 과소예측

### 2.2 60일 기준의 문제

- 퀀트 분석 본체: 90일~365일 기준 설계
- 시나리오 확률: 60일 기준
- **설계 불일치로 인한 신뢰도 저하**

---

## 3. Theme별 Calibration 개선안

### 3.1 권장 Calibration 승수 (데이터 기반)

분석 결과 도출된 **실제 데이터 기반 권장 승수**:

| Theme | Bullish 현재 | Bullish 권장 | Bearish 현재 | Bearish 권장 | 조정 방향 |
|-------|-------------|-------------|-------------|-------------|----------|
| Semiconductor | 1.32 | **1.20** | 3.01 | **0.63** | Bearish 대폭 감소 |
| AI_BigData | 1.32 | 0.72 | 3.01 | **1.24** | Bearish 유지/증가 |
| Finance | 1.32 | 0.55 | 3.01 | **0.45** | 둘 다 대폭 감소 |
| Consumer_Goods | 1.32 | 0.42 | 3.01 | **0.69** | 둘 다 대폭 감소 |
| Electronics | 1.32 | 0.75 | 3.01 | **0.78** | Bearish 감소 |
| Traditional_Manufacturing | 1.32 | 0.53 | 3.01 | **0.68** | 둘 다 감소 |
| Advanced_Manufacturing | 1.32 | 0.93 | 3.01 | **0.62** | Bearish 감소 |
| Shipbuilding | 1.32 | 0.97 | 3.01 | **0.77** | Bearish 감소 |
| Battery | 1.32 | 0.97 | 3.01 | **0.57** | Bearish 대폭 감소 |
| Bio_DrugRD | 1.32 | 0.93 | 3.01 | **0.73** | Bearish 감소 |
| Pharma_CDMO | 1.32 | 0.70 | 3.01 | **0.68** | 둘 다 감소 |
| Energy | 1.32 | 0.80 | 3.01 | **0.46** | Bearish 대폭 감소 |
| Materials_Chemical | 1.32 | 0.62 | 3.01 | **0.67** | 둘 다 감소 |
| IT_Software | 1.32 | 0.59 | 3.01 | **0.68** | 둘 다 감소 |
| Telecom_Media | 1.32 | 0.39 | 3.01 | **0.81** | 둘 다 감소 |
| Healthcare_Device | 1.32 | 0.62 | 3.01 | **0.85** | Bearish 감소 |
| Others | 1.32 | 0.38 | 3.01 | **0.70** | 둘 다 대폭 감소 |

### 3.2 Theme별 Calibration Map 구현안

```python
# 권장 구현: Theme별 분리된 Calibration Map
THEME_CALIBRATION_MAP = {
    'Semiconductor': {
        'bullish_multiplier': 1.20,  # 유일하게 증가 필요
        'bearish_multiplier': 0.63,
        'bearish_floor': 8
    },
    'AI_BigData': {
        'bullish_multiplier': 0.72,
        'bearish_multiplier': 1.24,  # 유일하게 증가 필요
        'bearish_floor': 15
    },
    'Finance': {
        'bullish_multiplier': 0.55,
        'bearish_multiplier': 0.45,
        'bearish_floor': 5
    },
    'Consumer_Goods': {
        'bullish_multiplier': 0.42,
        'bearish_multiplier': 0.69,
        'bearish_floor': 10
    },
    'Electronics': {
        'bullish_multiplier': 0.75,
        'bearish_multiplier': 0.78,
        'bearish_floor': 10
    },
    'Traditional_Manufacturing': {
        'bullish_multiplier': 0.53,
        'bearish_multiplier': 0.68,
        'bearish_floor': 10
    },
    'Advanced_Manufacturing': {
        'bullish_multiplier': 0.93,
        'bearish_multiplier': 0.62,
        'bearish_floor': 8
    },
    'Shipbuilding': {
        'bullish_multiplier': 0.97,
        'bearish_multiplier': 0.77,
        'bearish_floor': 8
    },
    'Battery': {
        'bullish_multiplier': 0.97,
        'bearish_multiplier': 0.57,
        'bearish_floor': 8
    },
    'Bio_DrugRD': {
        'bullish_multiplier': 0.93,
        'bearish_multiplier': 0.73,
        'bearish_floor': 10
    },
    'Pharma_CDMO': {
        'bullish_multiplier': 0.70,
        'bearish_multiplier': 0.68,
        'bearish_floor': 10
    },
    'Energy': {
        'bullish_multiplier': 0.80,
        'bearish_multiplier': 0.46,
        'bearish_floor': 5
    },
    'Materials_Chemical': {
        'bullish_multiplier': 0.62,
        'bearish_multiplier': 0.67,
        'bearish_floor': 10
    },
    'IT_Software': {
        'bullish_multiplier': 0.59,
        'bearish_multiplier': 0.68,
        'bearish_floor': 12
    },
    'Telecom_Media': {
        'bullish_multiplier': 0.39,
        'bearish_multiplier': 0.81,
        'bearish_floor': 15
    },
    'Healthcare_Device': {
        'bullish_multiplier': 0.62,
        'bearish_multiplier': 0.85,
        'bearish_floor': 12
    },
    'Others': {
        'bullish_multiplier': 0.38,
        'bearish_multiplier': 0.70,
        'bearish_floor': 10
    }
}
```

---

## 4. 예상 수익률 범위 개선안

### 4.1 현재 문제점

현재 예상 수익률 범위가 너무 넓어 실용성이 떨어짐.

예: `scenario_bullish_return = "+10~+25%"` (범위 15%p)

### 4.2 Theme별 실제 수익률 분포 (P25~P75 기준)

| Theme | Bullish 범위 | Sideways 범위 | Bearish 범위 |
|-------|-------------|---------------|--------------|
| Semiconductor | +22.4~+59.1% | -5.3~+3.6% | -21.4~-13.3% |
| Electronics | +15.2~+38.6% | -5.8~+2.2% | -22.3~-12.7% |
| Finance | +13.7~+27.8% | -2.1~+1.7% | -17.9~-11.8% |
| Consumer_Goods | +13.5~+28.4% | -6.0~+0.7% | -21.7~-12.4% |
| Traditional_Manufacturing | +14.6~+40.0% | -5.7~+1.8% | -19.9~-12.1% |
| Advanced_Manufacturing | +16.5~+46.9% | -5.2~+3.3% | -21.1~-12.5% |
| Battery | +16.7~+42.8% | -5.0~+3.9% | -21.7~-13.1% |
| Bio_DrugRD | +20.3~+52.0% | -4.5~+3.8% | -29.2~-12.6% |
| Pharma_CDMO | +16.4~+55.7% | -5.9~+1.1% | -22.4~-12.3% |
| IT_Software | +13.9~+25.8% | -6.0~+1.0% | -21.7~-12.5% |
| Telecom_Media | +12.5~+25.3% | -6.6~+0.8% | -20.9~-12.7% |
| AI_BigData | +13.9~+37.2% | -6.0~+4.0% | -23.7~-13.9% |
| Energy | +18.8~+42.2% | -4.3~+2.0% | -20.4~-12.4% |
| Shipbuilding | +17.4~+46.4% | +0.0~+5.1% | -24.3~-13.7% |
| Materials_Chemical | +14.4~+37.2% | -6.1~+1.4% | -17.7~-11.6% |
| Healthcare_Device | +16.4~+50.6% | -5.9~+1.4% | -22.3~-12.3% |
| Others | +13.7~+33.7% | -5.7~+1.0% | -18.3~-11.9% |

### 4.3 Score 구간별 실제 수익률 분포

| Score 구간 | Bullish 비율 | Bullish 범위 | Bearish 비율 | Bearish 범위 |
|-----------|-------------|-------------|-------------|--------------|
| 0-10 | 6.1% | +13.2~+25.3% | 33.9% | -18.8~-12.4% |
| 10-20 | 6.8% | +13.4~+30.2% | 29.7% | -20.3~-12.3% |
| 20-30 | 7.9% | +13.4~+32.8% | 28.1% | -19.3~-12.0% |
| 30-40 | 15.5% | +14.7~+37.8% | 22.1% | -20.8~-12.4% |
| 40-50 | 19.1% | +14.9~+38.7% | 19.9% | -21.2~-12.3% |
| 50-60 | 26.3% | +16.1~+45.6% | 21.8% | -22.4~-12.8% |
| 60-70 | 27.8% | +16.4~+43.5% | 18.6% | -23.7~-12.7% |
| 70-80 | 41.4% | +19.8~+55.5% | 16.0% | -21.6~-12.4% |
| 80+ | 52.7% | +20.6~+63.8% | 20.5% | -21.5~-13.6% |

### 4.4 권장 수익률 범위 계산 로직

```python
def get_return_range(theme: str, score_bucket: int, outcome: str) -> str:
    """
    Theme + Score 기반 수익률 범위 반환
    P25~P75 기준으로 범위 축소
    """
    # Theme별 기본 범위
    theme_ranges = THEME_RETURN_RANGES.get(theme, DEFAULT_RANGES)

    # Score에 따른 조정
    if outcome == 'bullish':
        if score_bucket >= 70:
            # 고점수: 상향 조정
            lower = theme_ranges['bullish_p25'] * 1.2
            upper = theme_ranges['bullish_p75'] * 1.2
        else:
            lower = theme_ranges['bullish_p25']
            upper = theme_ranges['bullish_p75']

    elif outcome == 'bearish':
        lower = theme_ranges['bearish_p25']
        upper = theme_ranges['bearish_p75']

    else:  # sideways
        lower = theme_ranges['sideways_p25']
        upper = theme_ranges['sideways_p75']

    return f"{lower:+.0f}~{upper:+.0f}%"
```

---

## 5. 신뢰도 기반 조정안

### 5.1 Sample Count 기반 가중치 조정

| Sample 범위 | 현재 w_backtest | 권장 w_backtest | 이유 |
|-------------|----------------|----------------|------|
| 0-19 | min(0.70, n/50) | **max(0.20, n/100)** | 신뢰도 낮음, Macro 비중 증가 |
| 20-49 | min(0.70, n/50) | min(0.50, n/50) | 보통 |
| 50-99 | min(0.70, n/50) | min(0.60, n/50) | 보통 |
| 100+ | min(0.70, n/50) | min(0.70, n/50) | 현행 유지 |

### 5.2 Backtest 평균 수익률 기반 조정

```python
def adjust_bearish_by_avg_return(raw_bearish: float, backtest_avg_return: float) -> float:
    """
    평균 수익률이 양수인데 Bearish가 높으면 감소
    """
    if backtest_avg_return > 5.0 and raw_bearish > 25:
        # 평균 수익률 +5% 이상인데 Bearish 25% 초과 -> 상한 제한
        return min(raw_bearish, 20)
    elif backtest_avg_return > 0 and raw_bearish > 30:
        # 평균 수익률 양수인데 Bearish 30% 초과 -> 상한 제한
        return min(raw_bearish, 25)
    return raw_bearish
```

---

## 6. 구현 우선순위

### 6.1 1단계: 즉시 적용 (긴급)

1. **Bearish Calibration 승수 완화**
   - (0-20%) 구간: 3.01 -> **1.50**
   - (20-40%) 구간: 1.48 -> **1.20**

2. **Backtest 평균 수익률 기반 Bearish 상한 적용**
   - 평균 수익률 > 0 이면 Bearish 최대 25%
   - 평균 수익률 > 5% 이면 Bearish 최대 20%

### 6.2 2단계: Theme별 Calibration (권장)

1. `kr_probability_calibrator.py` 수정
2. Theme별 CALIBRATION_MAP 적용
3. Theme별 Bearish Floor 적용

### 6.3 3단계: 예상 수익률 범위 개선 (선택)

1. Theme + Score 기반 동적 범위 계산
2. P25~P75 기준 적용

### 6.4 4단계: 60일 -> 90일 변경 검토 (장기)

1. 퀀트 설계와 일관성 확보
2. 데이터 재분석 필요

---

## 7. 예상 개선 효과

### 7.1 삼성전자 케이스 예상 변화

| 항목 | 현재 | 개선 후 |
|------|------|---------|
| Backtest Bearish | 6.7% | 6.7% |
| Calibration 후 Bearish | 36% | **15%** |
| 오차 | +29.3%p | **+8.3%p** |

### 7.2 전체 예측 정확도 예상 변화

| 구분 | 현재 오차 | 예상 오차 | 개선율 |
|------|----------|----------|--------|
| Bullish | 8.0%p | 4.0%p | 50% |
| Sideways | 18.4%p | 8.0%p | 57% |
| Bearish | 10.3%p | 4.0%p | 61% |
| **총 오차** | **36.7%p** | **16.0%p** | **56%** |

---

## 8. 참고: 분석 데이터 파일

| 파일명 | 설명 |
|--------|------|
| 1_theme_actual_distribution.csv | Theme별 실제 수익률 분포 |
| 2_theme_calibration_error.csv | Theme별 Calibration 오차 |
| 3_error_cases_samsung_pattern.csv | 삼성전자 패턴 오류 500건 |
| 4_sample_count_accuracy.csv | Sample Count별 예측 정확도 |
| 5_recommended_calibration_map.csv | Theme별 권장 승수 |
| 6_return_range_accuracy.csv | 예상 수익률 범위 정확도 |
| 7_return_percentiles_by_theme.csv | Theme별 수익률 백분위 |
| 8_return_percentiles_by_score.csv | Score별 수익률 백분위 |

---

**작성자**: Claude Code
**분석 스크립트**: `kr/analysis/analyze_scenario_calibration.py`
